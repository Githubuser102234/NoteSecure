<!DOCTYPE html>â€¨<html lang="en">â€¨<head>â€¨Â  Â  <meta charset="UTF-8">â€¨Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">â€¨Â  Â  <title>Advanced Personal Notes</title>â€¨Â  Â  <!-- Tailwind CSS CDN -->â€¨Â  Â  <script src="https://cdn.tailwindcss.com"></script>â€¨Â  Â  <!-- Inter Font -->â€¨Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">â€¨Â  Â  <style>â€¨Â  Â  Â  Â  body {â€¨Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;â€¨Â  Â  Â  Â  Â  Â  @apply bg-gray-50 text-gray-800;â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  Â  /* Custom scrollbar for better aesthetics */â€¨Â  Â  Â  Â  ::-webkit-scrollbar {â€¨Â  Â  Â  Â  Â  Â  width: 8px;â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  Â  ::-webkit-scrollbar-track {â€¨Â  Â  Â  Â  Â  Â  background: #f1f1f1;â€¨Â  Â  Â  Â  Â  Â  border-radius: 10px;â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  Â  ::-webkit-scrollbar-thumb {â€¨Â  Â  Â  Â  Â  Â  background: #888;â€¨Â  Â  Â  Â  Â  Â  border-radius: 10px;â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  Â  ::-webkit-scrollbar-thumb:hover {â€¨Â  Â  Â  Â  Â  Â  background: #555;â€¨Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  /* Shimmer loading effect */â€¨Â  Â  Â  Â  .shimmer-bg {â€¨Â  Â  Â  Â  Â  Â  /* Fallback background color, visible even if gradient fails */â€¨Â  Â  Â  Â  Â  Â  background-color: #e0e0e0;â€¨Â  Â  Â  Â  Â  Â  background: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%);â€¨Â  Â  Â  Â  Â  Â  background-size: 1000px 100%;â€¨Â  Â  Â  Â  Â  Â  animation: shimmer 1.5s infinite linear;â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  Â  @keyframes shimmer {â€¨Â  Â  Â  Â  Â  Â  0% {â€¨Â  Â  Â  Â  Â  Â  Â  Â  background-position: -1000px 0;â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  Â  100% {â€¨Â  Â  Â  Â  Â  Â  Â  Â  background-position: 1000px 0;â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  Â  .shimmer-card {â€¨Â  Â  Â  Â  Â  Â  @apply p-4 rounded-xl shadow-md bg-white;â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  Â  .shimmer-line {â€¨Â  Â  Â  Â  Â  Â  height: 16px;â€¨Â  Â  Â  Â  Â  Â  width: 90%;â€¨Â  Â  Â  Â  Â  Â  @apply rounded-md shimmer-bg mb-2;â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  Â  .shimmer-line-short {â€¨Â  Â  Â  Â  Â  Â  height: 16px;â€¨Â  Â  Â  Â  Â  Â  width: 60%;â€¨Â  Â  Â  Â  Â  Â  @apply rounded-md shimmer-bg;â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  Â  .shimmer-title {â€¨Â  Â  Â  Â  Â  Â  height: 24px;â€¨Â  Â  Â  Â  Â  Â  width: 70%;â€¨Â  Â  Â  Â  Â  Â  @apply rounded-md shimmer-bg mb-3;â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  Â  .shimmer-content {â€¨Â  Â  Â  Â  Â  Â  height: 48px;â€¨Â  Â  Â  Â  Â  Â  width: 100%;â€¨Â  Â  Â  Â  Â  Â  @apply rounded-md shimmer-bg mb-4;â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  Â  .shimmer-button {â€¨Â  Â  Â  Â  Â  Â  height: 36px;â€¨Â  Â  Â  Â  Â  Â  width: 80px;â€¨Â  Â  Â  Â  Â  Â  @apply rounded-md shimmer-bg;â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  Â  /* Specific shimmer for viewer title/content */â€¨Â  Â  Â  Â  .shimmer-text-block {â€¨Â  Â  Â  Â  Â  Â  @apply shimmer-bg rounded-md;â€¨Â  Â  Â  Â  Â  Â  height: 1.5em; /* Approximate line height */â€¨Â  Â  Â  Â  Â  Â  margin-bottom: 0.5em;â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  Â  .shimmer-text-block-lg {â€¨Â  Â  Â  Â  Â  Â  height: 2.5em; /* For titles */â€¨Â  Â  Â  Â  Â  Â  width: 70%;â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  Â  .shimmer-text-block-md {â€¨Â  Â  Â  Â  Â  Â  height: 1.5em; /* For content lines */â€¨Â  Â  Â  Â  Â  Â  width: 100%;â€¨Â  Â  Â  Â  }â€¨Â  Â  Â  Â  .shimmer-text-block-sm {â€¨Â  Â  Â  Â  Â  Â  height: 1.2em; /* For timestamps */â€¨Â  Â  Â  Â  Â  Â  width: 40%;â€¨Â  Â  Â  Â  }â€¨Â  Â  </style>â€¨</head>â€¨<body class="flex flex-col min-h-screen">â€¨Â  Â  <div id="app" class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">â€¨â€¨Â  Â  Â  Â  <!-- Message Modal -->â€¨Â  Â  Â  Â  <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">â€¨Â  Â  Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-lg w-11/12 max-w-sm">â€¨Â  Â  Â  Â  Â  Â  Â  Â  <h3 id="modalTitle" class="font-bold text-lg mb-2 text-gray-900"></h3>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <p id="modalMessage" class="text-gray-700 text-sm mb-4"></p>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-end space-x-2">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="modalConfirm" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition hidden">Confirm</button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="modalClose" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">Close</button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  </div>â€¨â€¨Â  Â  Â  Â  <!-- Auth Section -->â€¨Â  Â  Â  Â  <div id="authSection" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg border border-gray-200 mt-10 hidden">â€¨Â  Â  Â  Â  Â  Â  <h2 id="authHeading" class="text-3xl font-bold text-center mb-6 text-gray-900">Sign In</h2>â€¨â€¨Â  Â  Â  Â  Â  Â  <!-- Sign In Form -->â€¨Â  Â  Â  Â  Â  Â  <form id="signInForm" class="space-y-4">â€¨Â  Â  Â  Â  Â  Â  Â  Â  <div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="signInEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" id="signInEmail" placeholder="your@email.com" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required>â€¨Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="signInPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="signInPassword" placeholder="********" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required>â€¨Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="signInBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition">Sign In</button>â€¨Â  Â  Â  Â  Â  Â  </form>â€¨â€¨Â  Â  Â  Â  Â  Â  <!-- Sign Up Form -->â€¨Â  Â  Â  Â  Â  Â  <form id="signUpForm" class="space-y-4 hidden">â€¨Â  Â  Â  Â  Â  Â  Â  Â  <div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="signUpEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" id="signUpEmail" placeholder="your@email.com" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required>â€¨Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="signUpPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="signUpPassword" placeholder="********" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required>â€¨Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="signUpBtn" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition">Sign Up</button>â€¨Â  Â  Â  Â  Â  Â  </form>â€¨â€¨Â  Â  Â  Â  Â  Â  <div class="mt-6 text-center">â€¨Â  Â  Â  Â  Â  Â  Â  Â  <button id="toggleAuthMode" class="text-blue-600 hover:underline text-sm">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Don't have an account? Sign Upâ€¨Â  Â  Â  Â  Â  Â  Â  Â  </button>â€¨Â  Â  Â  Â  Â  Â  </div>â€¨â€¨Â  Â  Â  Â  Â  Â  <div class="relative flex items-center justify-center my-6">â€¨Â  Â  Â  Â  Â  Â  Â  Â  <div class="absolute inset-0 flex items-center">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="w-full border-t border-gray-300"></div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <div class="relative bg-white px-4 text-sm text-gray-500">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ORâ€¨Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  </div>â€¨â€¨Â  Â  Â  Â  Â  Â  <!-- Google Sign In Button -->â€¨Â  Â  Â  Â  Â  Â  <button type="button" id="googleSignInBtn" class="w-full bg-red-600 text-white p-3 rounded-lg font-semibold flex items-center justify-center space-x-2 hover:bg-red-700 transition">â€¨Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M7 11v2.4h3.97c-.16 1.02-.67 1.87-1.44 2.45v3.16h4.15c2.45-2.26 3.87-5.54 3.87-9.3A9.998 9.998 0 0012 3C6.48 3 2 7.48 2 13s4.48 10 10 10c4.78 0 8.87-3.08 9.9-7.38l-4.25-3.32c-.93 2.82-3.6 4.7-6.09 4.7-3.23 0-5.87-2.6-5.87-5.8S8.77 7.2 12 7.2c1.76 0 3.32.6 4.56 1.76L19 6.2C17.27 4.59 14.77 3 12 3 6.48 3 2 7.48 2 13s4.48 10 10 10z"/>â€¨Â  Â  Â  Â  Â  Â  Â  Â  </svg>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <span>Sign in with Google</span>â€¨Â  Â  Â  Â  Â  Â  </button>â€¨Â  Â  Â  Â  </div>â€¨â€¨Â  Â  Â  Â  <!-- Main Notes List Section -->â€¨Â  Â  Â  Â  <div id="notesSection" class="hidden">â€¨Â  Â  Â  Â  Â  Â  <header class="flex flex-col sm:flex-row items-center justify-between bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-6 border border-gray-200">â€¨Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-3xl font-bold text-gray-900 mb-4 sm:mb-0">Your Notes</h1>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center space-x-4">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="userIdDisplay" class="text-sm text-gray-600 font-medium"></span>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="signOutBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold">Sign Out</button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  </header>â€¨â€¨Â  Â  Â  Â  Â  Â  <!-- Add Note Form -->â€¨Â  Â  Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-lg mb-6 border border-gray-200">â€¨Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-semibold mb-4 text-gray-900">Add New Note</h3>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <form id="addNoteForm" class="space-y-4">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="noteTitle" class="block text-sm font-medium text-gray-700 mb-1">Title</label>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="noteTitle" placeholder="My awesome note title" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="noteContent" class="block text-sm font-medium text-gray-700 mb-1">Content</label>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="noteContent" rows="4" placeholder="Write your thoughts here..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition"></textarea>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="addNoteBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition">Add Note</button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  </form>â€¨Â  Â  Â  Â  Â  Â  </div>â€¨â€¨Â  Â  Â  Â  Â  Â  <!-- Notes List -->â€¨Â  Â  Â  Â  Â  Â  <div id="notesList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">â€¨Â  Â  Â  Â  Â  Â  Â  Â  <!-- Shimmer loading placeholders -->â€¨Â  Â  Â  Â  Â  Â  Â  Â  <div class="shimmer-card animate-pulse hidden" id="shimmerTemplate">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="shimmer-title"></div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="shimmer-content"></div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-end space-x-2 mt-4">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="shimmer-button"></div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="shimmer-button"></div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  </div>â€¨â€¨Â  Â  Â  Â  <!-- Single Note Viewer Section -->â€¨Â  Â  Â  Â  <div id="singleNoteViewerSection" class="hidden">â€¨Â  Â  Â  Â  Â  Â  <header class="flex flex-col sm:flex-row items-center justify-between bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-6 border border-gray-200">â€¨Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-3xl font-bold text-gray-900 mb-4 sm:mb-0">Note Details</h1>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center space-x-4">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="goHomeBtn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition font-semibold">Go Home</button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="toggleViewEditModeBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-semibold">Show in Editor Mode</button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="togglePublicStatusViewerBtn"â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="px-3 py-2 rounded-lg transition font-medium text-sm flex items-center justify-center text-whiteâ€¨ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title="Note is Private (Click to make public)">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ”—â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="signOutBtnViewer" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold">Sign Out</button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  </header>â€¨â€¨Â  Â  Â  Â  Â  Â  <div id="noteViewerContent" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 min-h-[200px]">â€¨Â  Â  Â  Â  Â  Â  Â  Â  <!-- Viewer Mode -->â€¨Â  Â  Â  Â  Â  Â  Â  Â  <div id="viewerMode" class="">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 id="viewerNoteTitle" class="text-3xl font-bold text-gray-900 mb-4"></h3>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="viewerNoteContent" class="text-gray-700 text-lg whitespace-pre-wrap min-h-[100px]"></p>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="viewerNoteTimestamp" class="text-gray-500 text-sm mt-6"></p>â€¨Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  <!-- Editor Mode -->â€¨Â  Â  Â  Â  Â  Â  Â  Â  <div id="editorMode" class="hidden space-y-4">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="editNoteFormViewer" class="space-y-4">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="editNoteIdViewer">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="editNoteTitleViewer" class="block text-sm font-medium text-gray-700 mb-1">Title</label>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="editNoteTitleViewer" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="editNoteContentViewer" class="block text-sm font-medium text-gray-700 mb-1">Content</label>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="editNoteContentViewer" rows="10" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition"></textarea>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-end space-x-3 mt-4">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="saveChangesBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold">Save Changes</button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>â€¨Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  </div>â€¨â€¨Â  Â  </div>â€¨â€¨Â  Â  <!-- Firebase SDKs -->â€¨Â  Â  <script type="module">â€¨Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";â€¨Â  Â  Â  Â  import {â€¨Â  Â  Â  Â  Â  Â  getAuth,â€¨Â  Â  Â  Â  Â  Â  signInWithEmailAndPassword,â€¨Â  Â  Â  Â  Â  Â  createUserWithEmailAndPassword,â€¨Â  Â  Â  Â  Â  Â  onAuthStateChanged,â€¨Â  Â  Â  Â  Â  Â  signOut,â€¨Â  Â  Â  Â  Â  Â  GoogleAuthProvider,â€¨Â  Â  Â  Â  Â  Â  signInWithPopupâ€¨Â  Â  Â  Â  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";â€¨Â  Â  Â  Â  import {â€¨Â  Â  Â  Â  Â  Â  getFirestore,â€¨Â  Â  Â  Â  Â  Â  collection,â€¨Â  Â  Â  Â  Â  Â  addDoc,â€¨Â  Â  Â  Â  Â  Â  serverTimestamp,â€¨Â  Â  Â  Â  Â  Â  query,â€¨Â  Â  Â  Â  Â  Â  onSnapshot,â€¨Â  Â  Â  Â  Â  Â  doc,â€¨Â  Â  Â  Â  Â  Â  getDoc,â€¨Â  Â  Â  Â  Â  Â  updateDoc,â€¨Â  Â  Â  Â  Â  Â  deleteDoc,â€¨Â  Â  Â  Â  Â  Â  setDoc // Added setDoc for public_notes_metadataâ€¨Â  Â  Â  Â  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";â€¨â€¨Â  Â  Â  Â  // Firebase Configuration (provided by user for GitHub Pages)â€¨Â  Â  Â  Â  const firebaseConfig = {â€¨Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyDs3PMoc6m-8jUFYn_sjDKXdSacAmrVjJE",â€¨Â  Â  Â  Â  Â  Â  authDomain: "notestorage-e4a87.firebaseapp.com",â€¨Â  Â  Â  Â  Â  Â  projectId: "notestorage-e4a87",â€¨Â  Â  Â  Â  Â  Â  storageBucket: "notestorage-e4a87.firebaseastorage.app",â€¨Â  Â  Â  Â  Â  Â  messagingSenderId: "674683993472",â€¨Â  Â  Â  Â  Â  Â  appId: "1:674683993472:web:d4ea28a5a77dfba459d565",â€¨Â  Â  Â  Â  Â  Â  measurementId: "G-WW2ZS4XNB7"â€¨Â  Â  Â  Â  };â€¨â€¨Â  Â  Â  Â  // Static App ID for Firestore path (derived from projectId)â€¨Â  Â  Â  Â  const appId = firebaseConfig.projectId;â€¨â€¨Â  Â  Â  Â  // Initialize Firebaseâ€¨Â  Â  Â  Â  const app = initializeApp(firebaseConfig);â€¨Â  Â  Â  Â  const auth = getAuth(app);â€¨Â  Â  Â  Â  const db = getFirestore(app);â€¨Â  Â  Â  Â  let currentUserId = null;â€¨Â  Â  Â  Â  let unsubscribeNotes = null; // To store the onSnapshot unsubscribe functionâ€¨â€¨Â  Â  Â  Â  // --- DOM Elements ---â€¨Â  Â  Â  Â  const authSection = document.getElementById('authSection');â€¨Â  Â  Â  Â  const notesSection = document.getElementById('notesSection');â€¨Â  Â  Â  Â  const authHeading = document.getElementById('authHeading');â€¨Â  Â  Â  Â  const signInForm = document.getElementById('signInForm');â€¨Â  Â  Â  Â  const signUpForm = document.getElementById('signUpForm');â€¨Â  Â  Â  Â  const toggleAuthMode = document.getElementById('toggleAuthMode');â€¨Â  Â  Â  Â  const googleSignInBtn = document.getElementById('googleSignInBtn');â€¨Â  Â  Â  Â  const signOutBtn = document.getElementById('signOutBtn'); // For main listâ€¨Â  Â  Â  Â  const userIdDisplay = document.getElementById('userIdDisplay');â€¨â€¨Â  Â  Â  Â  // Buttons with loading statesâ€¨Â  Â  Â  Â  const signInBtn = document.getElementById('signInBtn');â€¨Â  Â  Â  Â  const signUpBtn = document.getElementById('signUpBtn');â€¨Â  Â  Â  Â  const addNoteBtn = document.getElementById('addNoteBtn');â€¨â€¨Â  Â  Â  Â  const noteTitleInput = document.getElementById('noteTitle');â€¨Â  Â  Â  Â  const noteContentInput = document.getElementById('noteContent');â€¨Â  Â  Â  Â  const notesList = document.getElementById('notesList');â€¨Â  Â  Â  Â  const shimmerTemplate = document.getElementById('shimmerTemplate');â€¨â€¨Â  Â  Â  Â  const messageModal = document.getElementById('messageModal');â€¨Â  Â  Â  Â  const modalTitle = document.getElementById('modalTitle');â€¨Â  Â  Â  Â  const modalMessage = document.getElementById('modalMessage');â€¨Â  Â  Â  Â  const modalConfirm = document.getElementById('modalConfirm');â€¨Â  Â  Â  Â  const modalClose = document.getElementById('modalClose');â€¨â€¨Â  Â  Â  Â  // Single Note Viewer Elementsâ€¨Â  Â  Â  Â  const singleNoteViewerSection = document.getElementById('singleNoteViewerSection');â€¨Â  Â  Â  Â  const goHomeBtn = document.getElementById('goHomeBtn');â€¨Â  Â  Â  Â  const toggleViewEditModeBtn = document.getElementById('toggleViewEditModeBtn');â€¨Â  Â  Â  Â  const signOutBtnViewer = document.getElementById('signOutBtnViewer'); // For viewer pageâ€¨Â  Â  Â  Â  const togglePublicStatusViewerBtn = document.getElementById('togglePublicStatusViewerBtn'); // New Public/Private button for viewerâ€¨â€¨Â  Â  Â  Â  const viewerMode = document.getElementById('viewerMode');â€¨Â  Â  Â  Â  const editorMode = document.getElementById('editorMode');â€¨Â  Â  Â  Â  const viewerNoteTitle = document.getElementById('viewerNoteTitle');â€¨Â  Â  Â  Â  const viewerNoteContent = document.getElementById('viewerNoteContent');â€¨Â  Â  Â  Â  const viewerNoteTimestamp = document.getElementById('viewerNoteTimestamp');â€¨â€¨Â  Â  Â  Â  const editNoteFormViewer = document.getElementById('editNoteFormViewer');â€¨Â  Â  Â  Â  const editNoteIdViewer = document.getElementById('editNoteIdViewer');â€¨Â  Â  Â  Â  const editNoteTitleViewer = document.getElementById('editNoteTitleViewer');â€¨Â  Â  Â  Â  const editNoteContentViewer = document.getElementById('editNoteContentViewer');â€¨Â  Â  Â  Â  const saveChangesBtn = document.getElementById('saveChangesBtn');â€¨â€¨â€¨Â  Â  Â  Â  let isSignInMode = true; // State for auth formâ€¨Â  Â  Â  Â  let isViewerMode = true; // State for single note pageâ€¨â€¨Â  Â  Â  Â  // --- Utility Functions ---â€¨â€¨Â  Â  Â  Â  /**â€¨ Â  Â  Â  Â  * Displays a custom message modal.â€¨ Â  Â  Â  Â  * @param {string} title - The title of the modal.â€¨ Â  Â  Â  Â  * @param {string} message - The message content.â€¨ Â  Â  Â  Â  * @param {boolean} isConfirm - If true, shows a confirm button.â€¨ Â  Â  Â  Â  * @returns {Promise<boolean>} Resolves to true if confirmed, false if cancelled/closed.â€¨ Â  Â  Â  Â  */â€¨Â  Â  Â  Â  function showMessageModal(title, message, isConfirm = false) {â€¨Â  Â  Â  Â  Â  Â  return new Promise((resolve) => {â€¨Â  Â  Â  Â  Â  Â  Â  Â  modalTitle.textContent = title;â€¨Â  Â  Â  Â  Â  Â  Â  Â  modalMessage.textContent = message;â€¨Â  Â  Â  Â  Â  Â  Â  Â  messageModal.classList.remove('hidden');â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  if (isConfirm) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalConfirm.classList.remove('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalConfirm.onclick = () => {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  messageModal.classList.add('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalConfirm.classList.add('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve(true);â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };â€¨Â  Â  Â  Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalConfirm.classList.add('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  modalClose.onclick = () => {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  messageModal.classList.add('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalConfirm.classList.add('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve(false);â€¨Â  Â  Â  Â  Â  Â  Â  Â  };â€¨Â  Â  Â  Â  Â  Â  });â€¨Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  /**â€¨ Â  Â  Â  Â  * Displays shimmer loading effects for the notes list.â€¨ Â  Â  Â  Â  * @param {boolean} show - True to show, false to hide.â€¨ Â  Â  Â  Â  * @param {number} count - Number of shimmer items to display.â€¨ Â  Â  Â  Â  */â€¨Â  Â  Â  Â  function toggleNotesListShimmer(show, count = 3) {â€¨Â  Â  Â  Â  Â  Â  notesList.innerHTML = ''; // Clear existing notes/shimmersâ€¨Â  Â  Â  Â  Â  Â  if (show) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < count; i++) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const shimmerClone = shimmerTemplate.cloneNode(true);â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  shimmerClone.removeAttribute('id'); // Remove id from clonesâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  shimmerClone.classList.remove('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notesList.appendChild(shimmerClone);â€¨Â  Â  Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  Â  Â  notesList.innerHTML = ''; // Clear shimmersâ€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  /**â€¨ Â  Â  Â  Â  * Displays shimmer loading effects for the single note viewer.â€¨ Â  Â  Â  Â  * @param {boolean} show - True to show, false to hide.â€¨ Â  Â  Â  Â  */â€¨Â  Â  Â  Â  function toggleSingleNoteShimmer(show) {â€¨Â  Â  Â  Â  Â  Â  if (show) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  // Clear existing content and show shimmerâ€¨Â  Â  Â  Â  Â  Â  Â  Â  viewerNoteTitle.innerHTML = '<div class="shimmer-text-block shimmer-text-block-lg animate-pulse"></div>';â€¨Â  Â  Â  Â  Â  Â  Â  Â  viewerNoteContent.innerHTML = `â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="shimmer-text-block shimmer-text-block-md animate-pulse"></div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="shimmer-text-block shimmer-text-block-md w-11/12 animate-pulse"></div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="shimmer-text-block shimmer-text-block-md w-10/12 animate-pulse"></div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  `;â€¨Â  Â  Â  Â  Â  Â  Â  Â  viewerNoteTimestamp.innerHTML = '<div class="shimmer-text-block shimmer-text-block-sm animate-pulse"></div>';â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  // Apply shimmer directly to input fields when in editor modeâ€¨Â  Â  Â  Â  Â  Â  Â  Â  editNoteTitleViewer.classList.add('shimmer-bg', 'animate-pulse');â€¨Â  Â  Â  Â  Â  Â  Â  Â  editNoteContentViewer.classList.add('shimmer-bg', 'animate-pulse');â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  // Ensure the containers themselves are visibleâ€¨Â  Â  Â  Â  Â  Â  Â  Â  viewerNoteTitle.classList.remove('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  viewerNoteContent.classList.remove('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  viewerNoteTimestamp.classList.remove('hidden');â€¨â€¨Â  Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  Â  Â  // Clear shimmer from viewer and editor fieldsâ€¨Â  Â  Â  Â  Â  Â  Â  Â  viewerNoteTitle.innerHTML = '';â€¨Â  Â  Â  Â  Â  Â  Â  Â  viewerNoteContent.innerHTML = '';â€¨Â  Â  Â  Â  Â  Â  Â  Â  viewerNoteTimestamp.innerHTML = '';â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  editNoteTitleViewer.classList.remove('shimmer-bg', 'animate-pulse');â€¨Â  Â  Â  Â  Â  Â  Â  Â  editNoteContentViewer.classList.remove('shimmer-bg', 'animate-pulse');â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  }â€¨â€¨â€¨Â  Â  Â  Â  /**â€¨ Â  Â  Â  Â  * Sets the loading state for a button.â€¨ Â  Â  Â  Â  * @param {HTMLButtonElement} button - The button element.â€¨ Â  Â  Â  Â  * @param {boolean} isLoading - True to set loading state, false to reset.â€¨ Â  Â  Â  Â  * @param {string} originalText - The original text of the button.â€¨ Â  Â  Â  Â  */â€¨Â  Â  Â  Â  function setButtonLoading(button, isLoading, originalText) {â€¨Â  Â  Â  Â  Â  Â  if (isLoading) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  button.dataset.originalText = originalText; // Store original textâ€¨Â  Â  Â  Â  Â  Â  Â  Â  button.disabled = true;â€¨Â  Â  Â  Â  Â  Â  Â  Â  button.textContent = 'Loading...';â€¨Â  Â  Â  Â  Â  Â  Â  Â  button.classList.add('opacity-75', 'cursor-not-allowed');â€¨Â  Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  Â  Â  button.disabled = false;â€¨Â  Â  Â  Â  Â  Â  Â  Â  button.textContent = button.dataset.originalText || originalText; // Restore original textâ€¨Â  Â  Â  Â  Â  Â  Â  Â  button.classList.remove('opacity-75', 'cursor-not-allowed');â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  /**â€¨ Â  Â  Â  Â  * Applies exponential backoff for retrying API calls.â€¨ Â  Â  Â  Â  * @param {Function} apiCall - The API function to call.â€¨ Â  Â  Â  Â  * @param {Array} args - Arguments to pass to the API function.â€¨ Â  Â  Â  Â  * @param {number} retries - Number of retries.â€¨ Â  Â  Â  Â  * @param {number} delay - Initial delay in ms.â€¨ Â  Â  Â  Â  * @returns {Promise<any>} The result of the API call.â€¨ Â  Â  Â  Â  */â€¨Â  Â  Â  Â  async function withExponentialBackoff(apiCall, args = [], retries = 5, delay = 1000) {â€¨Â  Â  Â  Â  Â  Â  for (let i = 0; i < retries; i++) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  try {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return await apiCall(...args);â€¨Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (i < retries - 1) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(res => setTimeout(res, delay));â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delay *= 2; // Exponential increaseâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw error; // Re-throw if all retries failâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  /**â€¨ Â  Â  Â  Â  * Copies text to the clipboard using document.execCommand for better iframe compatibility.â€¨ Â  Â  Â  Â  * @param {string} text - The text to copy.â€¨ Â  Â  Â  Â  */â€¨Â  Â  Â  Â  function copyToClipboard(text) {â€¨Â  Â  Â  Â  Â  Â  const textarea = document.createElement('textarea');â€¨Â  Â  Â  Â  Â  Â  textarea.value = text;â€¨Â  Â  Â  Â  Â  Â  textarea.style.position = 'fixed'; // Avoid scrolling to bottomâ€¨Â  Â  Â  Â  Â  Â  textarea.style.opacity = 0;â€¨Â  Â  Â  Â  Â  Â  document.body.appendChild(textarea);â€¨Â  Â  Â  Â  Â  Â  textarea.focus();â€¨Â  Â  Â  Â  Â  Â  textarea.select();â€¨Â  Â  Â  Â  Â  Â  try {â€¨Â  Â  Â  Â  Â  Â  Â  Â  document.execCommand('copy');â€¨Â  Â  Â  Â  Â  Â  } catch (err) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  console.error('Failed to copy text: ', err);â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  Â  document.body.removeChild(textarea);â€¨Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  // --- Routing Logic ---â€¨â€¨Â  Â  Â  Â  /**â€¨ Â  Â  Â  Â  * Renders the appropriate section based on the URL.â€¨ Â  Â  Â  Â  */â€¨Â  Â  Â  Â  async function renderPage() {â€¨Â  Â  Â  Â  Â  Â  const params = new URLSearchParams(window.location.search);â€¨Â  Â  Â  Â  Â  Â  const noteId = params.get('noteid');â€¨â€¨Â  Â  Â  Â  Â  Â  // Hide all main sections firstâ€¨Â  Â  Â  Â  Â  Â  authSection.classList.add('hidden');â€¨Â  Â  Â  Â  Â  Â  notesSection.classList.add('hidden');â€¨Â  Â  Â  Â  Â  Â  singleNoteViewerSection.classList.add('hidden');â€¨â€¨Â  Â  Â  Â  Â  Â  if (noteId) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  // If a noteId is present, try to load the single note viewerâ€¨Â  Â  Â  Â  Â  Â  Â  Â  singleNoteViewerSection.classList.remove('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  await loadSingleNote(noteId);â€¨Â  Â  Â  Â  Â  Â  } else if (!currentUserId) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  // Not authenticated and no noteId, show auth sectionâ€¨Â  Â  Â  Â  Â  Â  Â  Â  authSection.classList.remove('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  // Ensure note list listener is unsubscribed when logged outâ€¨Â  Â  Â  Â  Â  Â  Â  Â  if (unsubscribeNotes) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unsubscribeNotes();â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unsubscribeNotes = null;â€¨Â  Â  Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  Â  Â  // Authenticated and no noteId, show main notes listâ€¨Â  Â  Â  Â  Â  Â  Â  Â  notesSection.classList.remove('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  loadNotesList();â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  // Listen for browser history changes (back/forward buttons)â€¨Â  Â  Â  Â  window.addEventListener('popstate', renderPage);â€¨â€¨Â  Â  Â  Â  /**â€¨ Â  Â  Â  Â  * Navigates to a new URL without a full page reload.â€¨ Â  Â  Â  Â  * @param {string} path - The path to navigate to (e.g., '/', '?noteid=abc').â€¨ Â  Â  Â  Â  */â€¨Â  Â  Â  Â  function navigate(path) {â€¨Â  Â  Â  Â  Â  Â  // Determine the base URL for GitHub Pages (e.g., /RepoName/)â€¨Â  Â  Â  Â  Â  Â  let baseUrl = window.location.origin;â€¨Â  Â  Â  Â  Â  Â  const pathname = window.location.pathname.split('?')[0]; // Get pathname without query stringâ€¨Â  Â  Â  Â  Â  Â  const lastSlashIndex = pathname.lastIndexOf('/');â€¨â€¨Â  Â  Â  Â  Â  Â  // If pathname ends with a file (e.g., /repo/index.html), go up one levelâ€¨Â  Â  Â  Â  Â  Â  if (lastSlashIndex > -1 && pathname.substring(lastSlashIndex + 1).includes('.')) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  baseUrl += pathname.substring(0, lastSlashIndex + 1);â€¨Â  Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  Â  Â  baseUrl += pathname;â€¨Â  Â  Â  Â  Â  Â  Â  Â  if (!baseUrl.endsWith('/')) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  baseUrl += '/';â€¨Â  Â  Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  Â  Â  // Ensure the path starts with '?' if it's a query string, or is just '/' for home.â€¨Â  Â  Â  Â  Â  Â  const targetPath = path.startsWith('?') || path === '/' ? path : '/' + path; // Ensure correct path formatâ€¨â€¨Â  Â  Â  Â  Â  Â  window.history.pushState({}, '', baseUrl + targetPath);â€¨Â  Â  Â  Â  Â  Â  renderPage();â€¨Â  Â  Â  Â  }â€¨â€¨â€¨Â  Â  Â  Â  // --- Auth Event Listeners ---â€¨Â  Â  Â  Â  toggleAuthMode.addEventListener('click', () => {â€¨Â  Â  Â  Â  Â  Â  isSignInMode = !isSignInMode;â€¨Â  Â  Â  Â  Â  Â  if (isSignInMode) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  authHeading.textContent = 'Sign In';â€¨Â  Â  Â  Â  Â  Â  Â  Â  signInForm.classList.remove('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  signUpForm.classList.add('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  toggleAuthMode.textContent = "Don't have an account? Sign Up";â€¨Â  Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  Â  Â  authHeading.textContent = 'Sign Up';â€¨Â  Â  Â  Â  Â  Â  Â  Â  signInForm.classList.add('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  signUpForm.classList.remove('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  toggleAuthMode.textContent = "Already have an account? Sign In";â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  });â€¨â€¨Â  Â  Â  Â  signInForm.addEventListener('submit', async (e) => {â€¨Â  Â  Â  Â  Â  Â  e.preventDefault();â€¨Â  Â  Â  Â  Â  Â  setButtonLoading(signInBtn, true, 'Sign In');â€¨Â  Â  Â  Â  Â  Â  const email = e.target.signInEmail.value;â€¨Â  Â  Â  Â  Â  Â  const password = e.target.signInPassword.value;â€¨Â  Â  Â  Â  Â  Â  try {â€¨Â  Â  Â  Â  Â  Â  Â  Â  await withExponentialBackoff(signInWithEmailAndPassword, [auth, email, password]);â€¨Â  Â  Â  Â  Â  Â  } catch (error) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Sign In Failed', error.message);â€¨Â  Â  Â  Â  Â  Â  } finally {â€¨Â  Â  Â  Â  Â  Â  Â  Â  setButtonLoading(signInBtn, false, 'Sign In');â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  });â€¨â€¨Â  Â  Â  Â  signUpForm.addEventListener('submit', async (e) => {â€¨Â  Â  Â  Â  Â  Â  e.preventDefault();â€¨Â  Â  Â  Â  Â  Â  setButtonLoading(signUpBtn, true, 'Sign Up');â€¨Â  Â  Â  Â  Â  Â  const email = e.target.signUpEmail.value;â€¨Â  Â  Â  Â  Â  Â  const password = e.target.signUpPassword.value;â€¨Â  Â  Â  Â  Â  Â  try {â€¨Â  Â  Â  Â  Â  Â  Â  Â  await withExponentialBackoff(createUserWithEmailAndPassword, [auth, email, password]);â€¨Â  Â  Â  Â  Â  Â  } catch (error) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Sign Up Failed', error.message);â€¨Â  Â  Â  Â  Â  Â  } finally {â€¨Â  Â  Â  Â  Â  Â  Â  Â  setButtonLoading(signUpBtn, false, 'Sign Up');â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  });â€¨â€¨Â  Â  Â  Â  googleSignInBtn.addEventListener('click', async () => {â€¨Â  Â  Â  Â  Â  Â  setButtonLoading(googleSignInBtn, true, 'Sign in with Google');â€¨Â  Â  Â  Â  Â  Â  const provider = new GoogleAuthProvider();â€¨Â  Â  Â  Â  Â  Â  try {â€¨Â  Â  Â  Â  Â  Â  Â  Â  await withExponentialBackoff(signInWithPopup, [auth, provider]);â€¨Â  Â  Â  Â  Â  Â  } catch (error) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  if (error.code !== 'auth/popup-closed-by-user') {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Google Sign In Failed', error.message);â€¨Â  Â  Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  Â  } finally {â€¨Â  Â  Â  Â  Â  Â  Â  Â  setButtonLoading(googleSignInBtn, false, 'Sign in with Google');â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  });â€¨â€¨Â  Â  Â  Â  signOutBtn.addEventListener('click', async () => {â€¨Â  Â  Â  Â  Â  Â  const confirmed = await showMessageModal('Confirm Sign Out', 'Are you sure you want to sign out?', true);â€¨Â  Â  Â  Â  Â  Â  if (confirmed) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  try {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await withExponentialBackoff(signOut, [auth]);â€¨Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Sign Out Failed', error.message);â€¨Â  Â  Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  });â€¨â€¨Â  Â  Â  Â  signOutBtnViewer.addEventListener('click', async () => {â€¨Â  Â  Â  Â  Â  Â  const confirmed = await showMessageModal('Confirm Sign Out', 'Are you sure you want to sign out?', true);â€¨Â  Â  Â  Â  Â  Â  if (confirmed) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  try {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await withExponentialBackoff(signOut, [auth]);â€¨Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Sign Out Failed', error.message);â€¨Â  Â  Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  });â€¨â€¨Â  Â  Â  Â  // --- Note Management Functions (Main List) ---â€¨â€¨Â  Â  Â  Â  /**â€¨ Â  Â  Â  Â  * Updates the appearance of the public toggle button based on note status.â€¨ Â  Â  Â  Â  * @param {HTMLElement} buttonElement - The button element to update.â€¨ Â  Â  Â  Â  * @param {boolean} isPublic - Current public status of the note.â€¨ Â  Â  Â  Â  */â€¨Â  Â  Â  Â  function updatePublicToggleButtonUI(buttonElement, isPublic) {â€¨Â  Â  Â  Â  Â  Â  if (isPublic) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  buttonElement.classList.remove('bg-red-600', 'hover:bg-red-700');â€¨Â  Â  Â  Â  Â  Â  Â  Â  buttonElement.classList.add('bg-green-600', 'hover:bg-green-700');â€¨Â  Â  Â  Â  Â  Â  Â  Â  buttonElement.title = 'Note is Public (Click to copy link)';â€¨Â  Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  Â  Â  buttonElement.classList.remove('bg-green-600', 'hover:bg-green-700');â€¨Â  Â  Â  Â  Â  Â  Â  Â  buttonElement.classList.add('bg-red-600', 'hover:bg-red-700');â€¨Â  Â  Â  Â  Â  Â  Â  Â  buttonElement.title = 'Note is Private (Click to make public)';â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  /**â€¨ Â  Â  Â  Â  * Toggles the public status of a note.â€¨ Â  Â  Â  Â  * @param {string} noteId - The ID of the note.â€¨ Â  Â  Â  Â  * @param {boolean} currentPublicStatus - The current public status of the note.â€¨ Â  Â  Â  Â  */â€¨Â  Â  Â  Â  async function togglePublicStatus(noteId, currentPublicStatus) {â€¨Â  Â  Â  Â  Â  Â  const confirmMessage = currentPublicStatusâ€¨Â  Â  Â  Â  Â  Â  Â  Â  ? 'Are you sure you want to make this note private? Others will no longer be able to view it.'â€¨Â  Â  Â  Â  Â  Â  Â  Â  : 'Are you sure you want to make this note public? Others will not be able to edit it, but view it. This can always be undone.';â€¨â€¨Â  Â  Â  Â  Â  Â  const confirmed = await showMessageModal('Confirm Action', confirmMessage, true);â€¨Â  Â  Â  Â  Â  Â  if (!confirmed) return;â€¨â€¨Â  Â  Â  Â  Â  Â  try {â€¨Â  Â  Â  Â  Â  Â  Â  Â  // Update the original note's `isPublic` statusâ€¨Â  Â  Â  Â  Â  Â  Â  Â  const noteDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/notes`, noteId);â€¨Â  Â  Â  Â  Â  Â  Â  Â  await withExponentialBackoff(updateDoc, [noteDocRef, { isPublic: !currentPublicStatus }]);â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  // Manage public_notes_metadataâ€¨Â  Â  Â  Â  Â  Â  Â  Â  const publicMetadataRef = doc(db, `artifacts/${appId}/public_notes_metadata`, noteId);â€¨Â  Â  Â  Â  Â  Â  Â  Â  if (!currentPublicStatus) { // Making it publicâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await withExponentialBackoff(setDoc, [publicMetadataRef, { ownerId: currentUserId }]);â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const publicLink = window.location.origin + window.location.pathname + `?noteid=${noteId}`;â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  copyToClipboard(publicLink);â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Success', 'Note is now public! The shareable link has been copied to your clipboard.');â€¨Â  Â  Â  Â  Â  Â  Â  Â  } else { // Making it privateâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await withExponentialBackoff(deleteDoc, [publicMetadataRef]);â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Success', 'Note is now private.');â€¨Â  Â  Â  Â  Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  // UI update for single note viewer, if applicableâ€¨Â  Â  Â  Â  Â  Â  Â  Â  if (!singleNoteViewerSection.classList.contains('hidden') && editNoteIdViewer.value === noteId) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const publicToggleButton = document.getElementById('togglePublicStatusViewerBtn');â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (publicToggleButton) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updatePublicToggleButtonUI(publicToggleButton, !currentPublicStatus);â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publicToggleButton.dataset.isPublic = !currentPublicStatus; // Update datasetâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  Â  Â  Â  // For main notes list, onSnapshot will handle UI refresh.â€¨â€¨Â  Â  Â  Â  Â  Â  } catch (error) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Error', 'Failed to change note visibility: ' + error.message);â€¨Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error toggling public status: ", error);â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  }â€¨â€¨â€¨Â  Â  Â  Â  /**â€¨ Â  Â  Â  Â  * Renders a single note card for the main list.â€¨ Â  Â  Â  Â  * @param {Object} note - The note object from Firestore.â€¨ Â  Â  Â  Â  * @returns {HTMLElement} The created note card element.â€¨ Â  Â  Â  Â  */â€¨Â  Â  Â  Â  function createNoteCard(note) {â€¨Â  Â  Â  Â  Â  Â  const noteCard = document.createElement('div');â€¨Â  Â  Â  Â  Â  Â  const isNotePublic = note.isPublic === true; // Ensure booleanâ€¨Â  Â  Â  Â  Â  Â  noteCard.id = `note-${note.id}`;â€¨Â  Â  Â  Â  Â  Â  noteCard.className = 'bg-white p-6 rounded-xl shadow-md border border-gray-200 flex flex-col justify-between transform transition-all duration-300 hover:scale-102 hover:shadow-lg cursor-pointer';â€¨Â  Â  Â  Â  Â  Â  noteCard.innerHTML = `â€¨Â  Â  Â  Â  Â  Â  Â  Â  <div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-xl font-semibold mb-2 text-gray-900">${note.title}</h4>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-700 text-sm mb-4">${note.content.substring(0, 100)}${note.content.length > 100 ? '...' : ''}</p>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-500 text-xs mt-2">Created: ${note.createdAt?.toDate ? new Date(note.createdAt.toDate()).toLocaleString() : 'N/A'}</p>â€¨Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-end space-x-2 mt-4">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-id="${note.id}" data-is-public="${isNotePublic}"â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="toggle-public-btn px-3 py-2 rounded-lg transition font-medium text-sm flex items-center justify-center text-whiteâ€¨ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isNotePublic ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}"â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title="${isNotePublic ? 'Note is Public (Click to copy link)' : 'Note is Private (Click to make public)'}"â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onclick="event.stopPropagation()">â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ”—â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-id="${note.id}"â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="edit-note-btn px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition font-medium text-sm" onclick="event.stopPropagation()">Edit</button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-id="${note.id}"â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="delete-note-btn px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-medium text-sm" onclick="event.stopPropagation()">Delete</button>â€¨Â  Â  Â  Â  Â  Â  Â  Â  </div>â€¨Â  Â  Â  Â  Â  Â  `;â€¨â€¨Â  Â  Â  Â  Â  Â  // Click listener for the card to navigate to the viewerâ€¨Â  Â  Â  Â  Â  Â  noteCard.addEventListener('click', () => {â€¨Â  Â  Â  Â  Â  Â  Â  Â  navigate(`?noteid=${note.id}`);â€¨Â  Â  Â  Â  Â  Â  });â€¨â€¨Â  Â  Â  Â  Â  Â  // Edit button handler (stops propagation to prevent card click)â€¨Â  Â  Â  Â  Â  Â  noteCard.querySelector('.edit-note-btn').addEventListener('click', (e) => {â€¨Â  Â  Â  Â  Â  Â  Â  Â  navigate(`?noteid=${e.target.dataset.id}`);â€¨Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Check if the viewer section is actually visible before trying to switch modeâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!singleNoteViewerSection.classList.contains('hidden')) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setViewerMode(false); // Switch to editor modeâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  Â  Â  Â  }, 100); // Small delay to ensure note is loaded before switching modeâ€¨Â  Â  Â  Â  Â  Â  });â€¨â€¨Â  Â  Â  Â  Â  Â  // Delete button handler (stops propagation to prevent card click)â€¨Â  Â  Â  Â  Â  Â  noteCard.querySelector('.delete-note-btn').addEventListener('click', async (e) => {â€¨Â  Â  Â  Â  Â  Â  Â  Â  const id = e.target.dataset.id;â€¨Â  Â  Â  Â  Â  Â  Â  Â  const confirmed = await showMessageModal('Confirm Delete', 'Are you sure you want to delete this note?', true);â€¨Â  Â  Â  Â  Â  Â  Â  Â  if (confirmed) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const noteDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/notes`, id);â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await withExponentialBackoff(deleteDoc, [noteDocRef]);â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Also delete from public metadata if it existsâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const publicMetadataRef = doc(db, `artifacts/${appId}/public_notes_metadata`, id);â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await withExponentialBackoff(deleteDoc, [publicMetadataRef]).catch(err => {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ignore if public metadata doesn't existâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (err.code !== 'not-found') console.warn("Could not delete public metadata for note:", id, err.message);â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Success', 'Note deleted successfully!');â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Error', 'Failed to delete note: ' + error.message);â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  Â  });â€¨â€¨Â  Â  Â  Â  Â  Â  // Public/Private button handlerâ€¨Â  Â  Â  Â  Â  Â  noteCard.querySelector('.toggle-public-btn').addEventListener('click', async (e) => {â€¨Â  Â  Â  Â  Â  Â  Â  Â  const id = e.target.dataset.id;â€¨Â  Â  Â  Â  Â  Â  Â  Â  const isPublic = e.target.dataset.isPublic === 'true'; // Convert string to booleanâ€¨Â  Â  Â  Â  Â  Â  Â  Â  await togglePublicStatus(id, isPublic);â€¨Â  Â  Â  Â  Â  Â  });â€¨â€¨â€¨Â  Â  Â  Â  Â  Â  return noteCard;â€¨Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  // --- Note Form Event Listeners (Main List) ---â€¨Â  Â  Â  Â  addNoteForm.addEventListener('submit', async (e) => {â€¨Â  Â  Â  Â  Â  Â  e.preventDefault();â€¨Â  Â  Â  Â  Â  Â  setButtonLoading(addNoteBtn, true, 'Add Note');â€¨Â  Â  Â  Â  Â  Â  const title = noteTitleInput.value.trim();â€¨Â  Â  Â  Â  Â  Â  const content = noteContentInput.value.trim();â€¨â€¨Â  Â  Â  Â  Â  Â  if (!title) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Input Error', 'Note title cannot be empty.');â€¨Â  Â  Â  Â  Â  Â  Â  Â  setButtonLoading(addNoteBtn, false, 'Add Note');â€¨Â  Â  Â  Â  Â  Â  Â  Â  return;â€¨Â  Â  Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  Â  Â  try {â€¨Â  Â  Â  Â  Â  Â  Â  Â  const notesCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/notes`);â€¨Â  Â  Â  Â  Â  Â  Â  Â  await withExponentialBackoff(addDoc, [notesCollectionRef, {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title,â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  content,â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isPublic: false, // Default to privateâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createdAt: serverTimestamp()â€¨Â  Â  Â  Â  Â  Â  Â  Â  }]);â€¨Â  Â  Â  Â  Â  Â  Â  Â  noteTitleInput.value = '';â€¨Â  Â  Â  Â  Â  Â  Â  Â  noteContentInput.value = '';â€¨Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Success', 'Note added successfully!');â€¨Â  Â  Â  Â  Â  Â  } catch (error) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Error', 'Failed to add note: ' + error.message);â€¨Â  Â  Â  Â  Â  Â  } finally {â€¨Â  Â  Â  Â  Â  Â  Â  Â  setButtonLoading(addNoteBtn, false, 'Add Note');â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  });â€¨â€¨Â  Â  Â  Â  // --- Single Note Viewer Functions ---â€¨â€¨Â  Â  Â  Â  /**â€¨ Â  Â  Â  Â  * Loads and displays a single note in the viewer section, handling public/private access.â€¨ Â  Â  Â  Â  * @param {string} noteId - The ID of the note to load.â€¨ Â  Â  Â  Â  */â€¨Â  Â  Â  Â  async function loadSingleNote(noteId) {â€¨Â  Â  Â  Â  Â  Â  // Unsubscribe from main notes list if currently activeâ€¨Â  Â  Â  Â  Â  Â  if (unsubscribeNotes) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  unsubscribeNotes();â€¨Â  Â  Â  Â  Â  Â  Â  Â  unsubscribeNotes = null;â€¨Â  Â  Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  Â  Â  setViewerMode(true); // Default to viewer mode initiallyâ€¨Â  Â  Â  Â  Â  Â  toggleSingleNoteShimmer(true); // Show shimmer for single note contentâ€¨â€¨Â  Â  Â  Â  Â  Â  let noteData = null;â€¨Â  Â  Â  Â  Â  Â  let noteOwnerId = null;â€¨Â  Â  Â  Â  Â  Â  let isNotePublic = false;â€¨â€¨Â  Â  Â  Â  Â  Â  // Elements for controlling visibility/interactivityâ€¨Â  Â  Â  Â  Â  Â  const publicToggleButton = document.getElementById('togglePublicStatusViewerBtn');â€¨Â  Â  Â  Â  Â  Â  const editModeToggleButton = document.getElementById('toggleViewEditModeBtn');â€¨Â  Â  Â  Â  Â  Â  const saveButton = document.getElementById('saveChangesBtn');â€¨Â  Â  Â  Â  Â  Â  const editTitleField = document.getElementById('editNoteTitleViewer');â€¨Â  Â  Â  Â  Â  Â  const editContentField = document.getElementById('editNoteContentViewer');â€¨â€¨â€¨Â  Â  Â  Â  Â  Â  // Hide all action buttons and disable edit fields by defaultâ€¨Â  Â  Â  Â  Â  Â  publicToggleButton.classList.add('hidden');â€¨Â  Â  Â  Â  Â  Â  publicToggleButton.disabled = true;â€¨Â  Â  Â  Â  Â  Â  editModeToggleButton.classList.add('hidden');â€¨Â  Â  Â  Â  Â  Â  saveButton.classList.add('hidden');â€¨Â  Â  Â  Â  Â  Â  editTitleField.disabled = true;â€¨Â  Â  Â  Â  Â  Â  editContentField.disabled = true;â€¨Â  Â  Â  Â  Â  Â  goHomeBtn.classList.remove('hidden'); // Always visibleâ€¨â€¨Â  Â  Â  Â  Â  Â  try {â€¨Â  Â  Â  Â  Â  Â  Â  Â  // Step 1: Check public_notes_metadata to see if the note is public and get its owner.â€¨Â  Â  Â  Â  Â  Â  Â  Â  const publicMetadataRef = doc(db, `artifacts/${appId}/public_notes_metadata`, noteId);â€¨Â  Â  Â  Â  Â  Â  Â  Â  const publicMetadataSnap = await withExponentialBackoff(getDoc, [publicMetadataRef]);â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  if (publicMetadataSnap.exists()) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isNotePublic = true;â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  noteOwnerId = publicMetadataSnap.data().ownerId;â€¨Â  Â  Â  Â  Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  // Step 2: Fetch the actual note document.â€¨Â  Â  Â  Â  Â  Â  Â  Â  let targetNoteDocRef;â€¨Â  Â  Â  Â  Â  Â  Â  Â  if (isNotePublic && noteOwnerId) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // If public, use the ownerId from metadataâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  targetNoteDocRef = doc(db, `artifacts/${appId}/users/${noteOwnerId}/notes`, noteId);â€¨Â  Â  Â  Â  Â  Â  Â  Â  } else if (currentUserId) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // If not public, or if current user is logged in, try to fetch from current user's notesâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  targetNoteDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/notes`, noteId);â€¨Â  Â  Â  Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Not public, and not logged in - cannot view.â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleSingleNoteShimmer(false);â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Access Denied', 'This note is private or does not exist. Please sign in to view your notes, or ensure you have a valid link to a public note.');â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  navigate('/');â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;â€¨Â  Â  Â  Â  Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  const noteSnap = await withExponentialBackoff(getDoc, [targetNoteDocRef]);â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  toggleSingleNoteShimmer(false); // Hide shimmer once data is fetchedâ€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  if (noteSnap.exists()) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  noteData = { id: noteSnap.id, ...noteSnap.data() };â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ensure noteData.isPublic is correct based on how it was fetched or actual statusâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (noteSnap.data().isPublic !== undefined) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  noteData.isPublic = noteSnap.data().isPublic;â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  noteData.isPublic = false; // Default to private if field is missingâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // If we fetched a public note, and currentUserId was null, noteOwnerId would have been set by metadata.â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // If currentUserId is present and we're looking at our own note, noteOwnerId might still be null (if not public metadata)â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // We need to confirm the true owner of the note to determine edit/manage permissionsâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!noteOwnerId && currentUserId) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // If noteOwnerId wasn't set by public metadata, and we are logged in, assume current user is owner.â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  noteOwnerId = currentUserId;â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  viewerNoteTitle.textContent = noteData.title;â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  viewerNoteContent.textContent = noteData.content;â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  viewerNoteTimestamp.textContent = `Created: ${noteData.createdAt?.toDate ? new Date(noteData.createdAt.toDate()).toLocaleString() : 'N/A'}`;â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Populate editor fieldsâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  editNoteIdViewer.value = noteData.id;â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  editNoteTitleViewer.value = noteData.title;â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  editNoteContentViewer.value = noteData.content;â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isCurrentUsersNote = (currentUserId === noteOwnerId);â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- Update UI for owner vs. viewer ---â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updatePublicToggleButtonUI(publicToggleButton, noteData.isPublic);â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publicToggleButton.dataset.noteId = noteData.id;â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publicToggleButton.dataset.isPublic = noteData.isPublic;â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isCurrentUsersNote) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Current user is the owner, enable controlsâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publicToggleButton.classList.remove('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publicToggleButton.disabled = false;â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  editModeToggleButton.classList.remove('hidden'); // Allow switching to editor modeâ€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Make edit fields editableâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  editTitleField.disabled = false;â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  editContentField.disabled = false;â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ensure save button state is correct if in editor modeâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isViewerMode) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveButton.classList.remove('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveButton.classList.add('hidden'); // Hide save button in viewer modeâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Not the owner, hide/disable editing and visibility controlsâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publicToggleButton.classList.add('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publicToggleButton.disabled = true;â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  editModeToggleButton.classList.add('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveButton.classList.add('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  editTitleField.disabled = true;â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  editContentField.disabled = true;â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setViewerMode(true); // Force viewer mode if not ownerâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }â€¨â€¨â€¨Â  Â  Â  Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Note not found with any accessible pathâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Error', 'Note not found or you do not have permission to view it.');â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  navigate('/'); // Go back to home if note doesn't exist or no accessâ€¨Â  Â  Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  Â  } catch (error) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  toggleSingleNoteShimmer(false); // Hide shimmer on errorâ€¨Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error loading single note: ", error);â€¨Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Error', 'Failed to load note: ' + error.message);â€¨Â  Â  Â  Â  Â  Â  Â  Â  navigate('/'); // Go back to home on errorâ€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  /**â€¨ Â  Â  Â  Â  * Toggles between viewer and editor mode for a single note.â€¨ Â  Â  Â  Â  * Only allows editor mode if the current user is the owner.â€¨ Â  Â  Â  Â  * @param {boolean} isView - True for viewer mode, false for editor mode.â€¨ Â  Â  Â  Â  */â€¨Â  Â  Â  Â  function setViewerMode(isView) {â€¨Â  Â  Â  Â  Â  Â  isViewerMode = isView;â€¨â€¨Â  Â  Â  Â  Â  Â  // Check if the current user is the owner. If the edit fields are disabled, they are not the owner.â€¨Â  Â  Â  Â  Â  Â  const isOwner = !editNoteTitleViewer.disabled;â€¨â€¨Â  Â  Â  Â  Â  Â  if (isViewerMode || !isOwner) { // If going to viewer mode, OR if not owner, force viewer mode.â€¨Â  Â  Â  Â  Â  Â  Â  Â  viewerMode.classList.remove('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  editorMode.classList.add('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  toggleViewEditModeBtn.textContent = 'Show in Editor Mode';â€¨Â  Â  Â  Â  Â  Â  Â  Â  saveChangesBtn.classList.add('hidden'); // Hide save button in viewer modeâ€¨Â  Â  Â  Â  Â  Â  } else { // Only allow editor mode if owner AND explicitly requestedâ€¨Â  Â  Â  Â  Â  Â  Â  Â  viewerMode.classList.add('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  editorMode.classList.remove('hidden');â€¨Â  Â  Â  Â  Â  Â  Â  Â  toggleViewEditModeBtn.textContent = 'Show in Viewer Mode';â€¨Â  Â  Â  Â  Â  Â  Â  Â  saveChangesBtn.classList.remove('hidden'); // Show save button in editor mode for ownerâ€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  // --- Single Note Viewer Event Listeners ---â€¨Â  Â  Â  Â  goHomeBtn.addEventListener('click', () => {â€¨Â  Â  Â  Â  Â  Â  navigate('/');â€¨Â  Â  Â  Â  });â€¨â€¨Â  Â  Â  Â  toggleViewEditModeBtn.addEventListener('click', () => {â€¨Â  Â  Â  Â  Â  Â  setViewerMode(!isViewerMode);â€¨Â  Â  Â  Â  });â€¨â€¨Â  Â  Â  Â  togglePublicStatusViewerBtn.addEventListener('click', async () => {â€¨Â  Â  Â  Â  Â  Â  const noteId = togglePublicStatusViewerBtn.dataset.noteId;â€¨Â  Â  Â  Â  Â  Â  const currentPublicStatus = togglePublicStatusViewerBtn.dataset.isPublic === 'true'; // Convert string to booleanâ€¨Â  Â  Â  Â  Â  Â  await togglePublicStatus(noteId, currentPublicStatus);â€¨Â  Â  Â  Â  Â  Â  // After toggling, reload the single note to ensure all states are refreshed.â€¨Â  Â  Â  Â  Â  Â  await loadSingleNote(noteId);â€¨Â  Â  Â  Â  });â€¨â€¨Â  Â  Â  Â  editNoteFormViewer.addEventListener('submit', async (e) => {â€¨Â  Â  Â  Â  Â  Â  e.preventDefault();â€¨Â  Â  Â  Â  Â  Â  setButtonLoading(saveChangesBtn, true, 'Save Changes');â€¨Â  Â  Â  Â  Â  Â  const id = editNoteIdViewer.value;â€¨Â  Â  Â  Â  Â  Â  const title = editNoteTitleViewer.value.trim();â€¨Â  Â  Â  Â  Â  Â  const content = editNoteContentViewer.value.trim();â€¨â€¨Â  Â  Â  Â  Â  Â  if (!title) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Input Error', 'Note title cannot be empty.');â€¨Â  Â  Â  Â  Â  Â  Â  Â  setButtonLoading(saveChangesBtn, false, 'Save Changes');â€¨Â  Â  Â  Â  Â  Â  Â  Â  return;â€¨Â  Â  Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  Â  Â  try {â€¨Â  Â  Â  Â  Â  Â  Â  Â  const noteDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/notes`, id);â€¨Â  Â  Â  Â  Â  Â  Â  Â  await withExponentialBackoff(updateDoc, [noteDocRef, {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title,â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentâ€¨Â  Â  Â  Â  Â  Â  Â  Â  }]);â€¨Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Success', 'Note updated successfully!');â€¨Â  Â  Â  Â  Â  Â  Â  Â  setViewerMode(true); // Switch back to viewer mode after savingâ€¨Â  Â  Â  Â  Â  Â  Â  Â  await loadSingleNote(id); // Reload the note to reflect changesâ€¨Â  Â  Â  Â  Â  Â  } catch (error) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Error', 'Failed to update note: ' + error.message);â€¨Â  Â  Â  Â  Â  Â  } finally {â€¨Â  Â  Â  Â  Â  Â  Â  Â  setButtonLoading(saveChangesBtn, false, 'Save Changes');â€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  });â€¨â€¨â€¨Â  Â  Â  Â  // --- Authentication State Observer ---â€¨Â  Â  Â  Â  onAuthStateChanged(auth, async (user) => {â€¨Â  Â  Â  Â  Â  Â  currentUserId = user ? user.uid : null;â€¨â€¨Â  Â  Â  Â  Â  Â  if (user) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  userIdDisplay.textContent = `User ID: ${user.uid}`;â€¨Â  Â  Â  Â  Â  Â  Â  Â  renderPage(); // Render appropriate page after auth state is knownâ€¨Â  Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  Â  Â  // User logged outâ€¨Â  Â  Â  Â  Â  Â  Â  Â  currentUserId = null;â€¨Â  Â  Â  Â  Â  Â  Â  Â  if (unsubscribeNotes) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unsubscribeNotes(); // Unsubscribe from notes listenerâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unsubscribeNotes = null;â€¨Â  Â  Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  Â  Â  Â  navigate('/'); // Go to home (which will show auth section or public note)â€¨Â  Â  Â  Â  Â  Â  Â  Â  // renderPage will be called by navigateâ€¨Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  });â€¨â€¨Â  Â  Â  Â  /**â€¨ Â  Â  Â  Â  * Sets up the real-time listener for the main notes list.â€¨ Â  Â  Â  Â  */â€¨Â  Â  Â  Â  function loadNotesList() {â€¨Â  Â  Â  Â  Â  Â  if (!currentUserId || !db) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  console.error("Cannot load notes list: User not authenticated or Firestore not initialized.");â€¨Â  Â  Â  Â  Â  Â  Â  Â  return;â€¨Â  Â  Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  Â  Â  toggleNotesListShimmer(true); // Show shimmer while loading notesâ€¨â€¨Â  Â  Â  Â  Â  Â  // If there's an existing listener, unsubscribe it firstâ€¨Â  Â  Â  Â  Â  Â  if (unsubscribeNotes) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  unsubscribeNotes();â€¨Â  Â  Â  Â  Â  Â  }â€¨â€¨Â  Â  Â  Â  Â  Â  const notesCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/notes`);â€¨Â  Â  Â  Â  Â  Â  const q = query(notesCollectionRef); // orderBy commented out to avoid index issuesâ€¨â€¨Â  Â  Â  Â  Â  Â  unsubscribeNotes = onSnapshot(q, (snapshot) => {â€¨Â  Â  Â  Â  Â  Â  Â  Â  toggleNotesListShimmer(false); // Hide shimmer once data is receivedâ€¨Â  Â  Â  Â  Â  Â  Â  Â  notesList.innerHTML = ''; // Clear notes before re-renderingâ€¨Â  Â  Â  Â  Â  Â  Â  Â  if (snapshot.empty) {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notesList.innerHTML = '<p class="col-span-full text-center text-gray-500 text-lg py-10">No notes yet. Add your first note!</p>';â€¨Â  Â  Â  Â  Â  Â  Â  Â  } else {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const notesData = [];â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  snapshot.forEach(doc => {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notesData.push({ id: doc.id, ...doc.data() });â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Sort notes in memory by createdAt descendingâ€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notesData.sort((a, b) => {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const timeA = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const timeB = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return timeB - timeA;â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notesData.forEach(note => {â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notesList.appendChild(createNoteCard(note));â€¨Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });â€¨Â  Â  Â  Â  Â  Â  Â  Â  }â€¨Â  Â  Â  Â  Â  Â  }, (error) => {â€¨Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error fetching notes: ", error);â€¨Â  Â  Â  Â  Â  Â  Â  Â  showMessageModal('Error', 'Failed to load notes: ' + error.message);â€¨Â  Â  Â  Â  Â  Â  Â  Â  toggleNotesListShimmer(false); // Hide shimmer on errorâ€¨Â  Â  Â  Â  Â  Â  });â€¨Â  Â  Â  Â  }â€¨â€¨â€¨Â  Â  Â  Â  // Initial page render on window loadâ€¨Â  Â  Â  Â  window.onload = () => {â€¨Â  Â  Â  Â  Â  Â  shimmerTemplate.classList.add('hidden'); // Hide the template after initial loadâ€¨Â  Â  Â  Â  Â  Â  // onAuthStateChanged will trigger renderPage after auth state is determinedâ€¨Â  Â  Â  Â  };â€¨â€¨Â  Â  </script>â€¨</body>â€¨</html>â€¨
