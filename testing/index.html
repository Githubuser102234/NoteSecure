<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NoteSecure">
<link rel="apple-touch-icon" href="https://githubuser102234.github.io/NoteSecure/media/IMG_0787.jpeg">
<link rel="apple-touch-icon" sizes="512x512" href="https://githubuser102234.github.io/NoteSecure/media/IMG_0787.jpeg">
<link rel="apple-touch-startup-image" href="https://githubuser102234.github.io/NoteSecure/media/IMG_0787.jpeg">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoteSecure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-50 text-gray-800;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Shimmer loading effect */
        .shimmer-bg {
            /* Fallback background color, visible even if gradient fails */
            background-color: #e0e0e0;
            background: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%);
            background-size: 1000px 100%;
            animation: shimmer 1.5s infinite linear;
        }
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }
        .shimmer-card {
            @apply p-4 rounded-xl shadow-md bg-white;
        }
        .shimmer-line {
            height: 16px;
            width: 90%;
            @apply rounded-md shimmer-bg mb-2;
        }
        .shimmer-line-short {
            height: 16px;
            width: 60%;
            @apply rounded-md shimmer-bg;
        }
        .shimmer-title {
            height: 24px;
            width: 70%;
            @apply rounded-md shimmer-bg mb-3;
        }
        .shimmer-content {
            height: 48px;
            width: 100%;
            @apply rounded-md shimmer-bg mb-4;
        }
        .shimmer-button {
            height: 36px;
            width: 80px;
            @apply rounded-md shimmer-bg;
        }
        /* Specific shimmer for viewer title/content */
        .shimmer-text-block {
            @apply shimmer-bg rounded-md;
            height: 1.5em; /* Approximate line height */
            margin-bottom: 0.5em;
        }
        .shimmer-text-block-lg {
            height: 2.5em; /* For titles */
            width: 70%;
        }
        .shimmer-text-block-md {
            height: 1.5em; /* For content lines */
            width: 100%;
        }
        .shimmer-text-block-sm {
            height: 1.2em; /* For timestamps */
            width: 40%;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <div id="app" class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">

        <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg w-11/12 max-w-sm">
                <h3 id="modalTitle" class="font-bold text-lg mb-2 text-gray-900"></h3>
                <p id="modalMessage" class="text-gray-700 text-sm mb-4"></p>
                <div class="flex justify-end space-x-2">
                    <button id="modalConfirm" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition hidden">Confirm</button>
                    <button id="modalClose" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">Close</button>
                </div>
            </div>
        </div>

        <div id="authSection" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg border border-gray-200 mt-10 hidden">
            <h2 id="authHeading" class="text-3xl font-bold text-center mb-6 text-gray-900">Sign In</h2>

            <form id="signInForm" class="space-y-4">
                <div>
                    <label for="signInEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="signInEmail" placeholder="your@email.com" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required>
                </div>
                <div>
                    <label for="signInPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="signInPassword" placeholder="********" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required>
                </div>
                <button type="submit" id="signInBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition">Sign In</button>
            </form>

            <form id="signUpForm" class="space-y-4 hidden">
                <div>
                    <label for="signUpEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="signUpEmail" placeholder="your@email.com" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required>
                </div>
                <div>
                    <label for="signUpPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="signUpPassword" placeholder="********" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required>
                </div>
                <button type="submit" id="signUpBtn" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition">Sign Up</button>
            </form>
            
            <div class="mt-4 text-center">
                <button id="forgotPasswordBtn" class="text-blue-600 hover:underline text-sm">
                    Forgot Password?
                </button>
            </div>

            <div class="mt-6 text-center">
                <button id="toggleAuthMode" class="text-blue-600 hover:underline text-sm">
                    Don't have an account? Sign Up
                </button>
            </div>

            <div class="relative flex items-center justify-center my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative bg-white px-4 text-sm text-gray-500">
                    OR
                </div>
            </div>

            <button type="button" id="googleSignInBtn" class="w-full bg-red-600 text-white p-3 rounded-lg font-semibold flex items-center justify-center space-x-2 hover:bg-red-700 transition">
                <img src="https://githubuser102234.github.io/NoteSecure/media/IMG_0789.png" class="w-5 h-5" alt="Google logo">
                <span>Sign in with Google</span>
            </button>
        </div>

        <div id="notesSection" class="hidden">
            <header class="flex flex-col sm:flex-row items-center justify-between bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-6 border border-gray-200">
                <div class="flex-1 mb-4 sm:mb-0">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Your Notes</h1>
                    <div class="relative w-full max-w-md">
                        <input type="text" id="searchInput" placeholder="Search notes by title or content..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition pl-10 pr-4">
                        <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userIdDisplay" class="text-sm text-gray-600 font-medium shimmer-bg rounded-md h-5 w-24 animate-pulse"></span>
                    <button type="button" id="signOutBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold">Sign Out</button>
                </div>
            </header>

            <div class="bg-white p-6 rounded-xl shadow-lg mb-6 border border-gray-200">
                <h3 class="text-2xl font-semibold mb-4 text-gray-900">Add New Note</h3>
                <form id="addNoteForm" class="space-y-4">
                    <div>
                        <label for="noteTitle" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                        <input type="text" id="noteTitle" placeholder="My awesome note title" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required>
                    </div>
                    <div>
                        <label for="noteContent" class="block text-sm font-medium text-gray-700 mb-1">Content</label>
                        <textarea id="noteContent" rows="4" placeholder="Write your thoughts here..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition"></textarea>
                    </div>
                    <button type="submit" id="addNoteBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition">Add Note</button>
                </form>
            </div>

            <div id="notesList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="shimmer-card animate-pulse hidden" id="shimmerTemplate">
                    <div class="shimmer-title"></div>
                    <div class="shimmer-content"></div>
                    <div class="flex justify-end space-x-2 mt-4">
                        <div class="shimmer-button"></div>
                        <div class="shimmer-button"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="singleNoteViewerSection" class="hidden">
            <header class="flex flex-col sm:flex-row items-center justify-between bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-6 border border-gray-200">
                <h1 class="text-3xl font-bold text-gray-900 mb-4 sm:mb-0">Note Details</h1>
                <div class="flex items-center space-x-4">
                    <button type="button" id="goHomeBtn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition font-semibold">Go Home</button>
                    <button type="button" id="toggleViewEditModeBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-semibold">Show in Editor Mode</button>
                    <button type="button" id="signOutBtnViewer" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold">Sign Out</button>
                </div>
            </header>

            <div id="noteViewerContent" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 min-h-[200px]">
                <div id="viewerMode" class="">
                    <h3 id="viewerNoteTitle" class="text-3xl font-bold text-gray-900 mb-4 shimmer-bg rounded-md h-8 w-3/4 animate-pulse"></h3>
                    <p id="viewerNoteContent" class="text-gray-700 text-lg whitespace-pre-wrap min-h-[100px] shimmer-bg rounded-md h-24 w-full animate-pulse"></p>
                    <p id="viewerNoteTimestamp" class="text-gray-500 text-sm mt-6 shimmer-bg rounded-md h-5 w-1/3 animate-pulse"></p>
                    <button id="copyTextBtn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold">Copy Text</button>
                </div>

                <div id="editorMode" class="hidden space-y-4">
                    <form id="editNoteFormViewer" class="space-y-4">
                        <input type="hidden" id="editNoteIdViewer">
                        <div>
                            <label for="editNoteTitleViewer" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                            <input type="text" id="editNoteTitleViewer" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition shimmer-bg animate-pulse" required>
                        </div>
                        <div>
                            <label for="editNoteContentViewer" class="block text-sm font-medium text-gray-700 mb-1">Content</label>
                            <textarea id="editNoteContentViewer" rows="10" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition shimmer-bg animate-pulse"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3 mt-4">
                            <button type="submit" id="saveChangesBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            onAuthStateChanged,
            signOut,
            GoogleAuthProvider,
            signInWithPopup,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            serverTimestamp,
            query,
            onSnapshot,
            doc,
            getDoc,
            updateDoc,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (provided by user for GitHub Pages)
        const firebaseConfig = {
            apiKey: "AIzaSyDs3PMoc6m-8jUFYn_sjDKXdSacAmrVjJE",
            authDomain: "notestorage-e4a87.firebaseapp.com",
            projectId: "notestorage-e4a87",
            storageBucket: "notestorage-e4a87.firebasestorage.app",
            messagingSenderId: "674683993472",
            appId: "1:674683993472:web:d4ea28a5a77dfba459d565",
            measurementId: "G-WW2ZS4XNB7"
        };

        // Static App ID for Firestore path (derived from projectId)
        const appId = firebaseConfig.projectId;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUserId = null;
        let unsubscribeNotes = null; // To store the onSnapshot unsubscribe function
        let allNotes = []; // Store all notes for local searching

        // --- DOM Elements ---
        const authSection = document.getElementById('authSection');
        const notesSection = document.getElementById('notesSection');
        const authHeading = document.getElementById('authHeading');
        const signInForm = document.getElementById('signInForm');
        const signUpForm = document.getElementById('signUpForm');
        const toggleAuthMode = document.getElementById('toggleAuthMode');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const signOutBtn = document.getElementById('signOutBtn'); // For main list
        const userIdDisplay = document.getElementById('userIdDisplay');
        const searchInput = document.getElementById('searchInput'); // New search input

        // Added forgot password button
        const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');

        // Buttons with loading states
        const signInBtn = document.getElementById('signInBtn');
        const signUpBtn = document.getElementById('signUpBtn');
        const addNoteBtn = document.getElementById('addNoteBtn');

        const noteTitleInput = document.getElementById('noteTitle');
        const noteContentInput = document.getElementById('noteContent');
        const notesList = document.getElementById('notesList');
        const shimmerTemplate = document.getElementById('shimmerTemplate');

        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirm = document.getElementById('modalConfirm');
        const modalClose = document.getElementById('modalClose');

        // Single Note Viewer Elements
        const singleNoteViewerSection = document.getElementById('singleNoteViewerSection');
        const goHomeBtn = document.getElementById('goHomeBtn');
        const toggleViewEditModeBtn = document.getElementById('toggleViewEditModeBtn');
        const signOutBtnViewer = document.getElementById('signOutBtnViewer'); // For viewer page

        const viewerMode = document.getElementById('viewerMode');
        const editorMode = document.getElementById('editorMode');
        const viewerNoteTitle = document.getElementById('viewerNoteTitle');
        const viewerNoteContent = document.getElementById('viewerNoteContent');
        const viewerNoteTimestamp = document.getElementById('viewerNoteTimestamp');
        
        // New: Get the "Copy Text" button
        const copyTextBtn = document.getElementById('copyTextBtn');

        const editNoteFormViewer = document.getElementById('editNoteFormViewer');
        const editNoteIdViewer = document.getElementById('editNoteIdViewer');
        const editNoteTitleViewer = document.getElementById('editNoteTitleViewer');
        const editNoteContentViewer = document.getElementById('editNoteContentViewer');
        const saveChangesBtn = document.getElementById('saveChangesBtn');


        let isSignInMode = true; // State for auth form
        let isViewerMode = true; // State for single note page
        let shimmerCount = 0; // Tracks the number of shimmer elements currently in the DOM

        // --- Utility Functions ---

        /**
         * Displays a custom message modal.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message content.
         * @param {boolean} isConfirm - If true, shows a confirm button.
         * @returns {Promise<boolean>} Resolves to true if confirmed, false if cancelled/closed.
         */
        function showMessageModal(title, message, isConfirm = false) {
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                messageModal.classList.remove('hidden');

                if (isConfirm) {
                    modalConfirm.classList.remove('hidden');
                    modalConfirm.onclick = () => {
                        messageModal.classList.add('hidden');
                        modalConfirm.classList.add('hidden');
                        resolve(true);
                    };
                } else {
                    modalConfirm.classList.add('hidden');
                }

                modalClose.onclick = () => {
                    messageModal.classList.add('hidden');
                    modalConfirm.classList.add('hidden');
                    resolve(false);
                };
            });
        }

        /**
         * Displays shimmer loading effects for the notes list.
         * @param {boolean} show - True to show, false to hide.
         * @param {number} count - Number of shimmer items to display.
         */
        function toggleNotesListShimmer(show, count = 3) {
            if (show) {
                // Add shimmer elements only if they are not already present
                if (shimmerCount === 0) {
                    notesList.innerHTML = ''; // Clear existing notes/shimmers
                    for (let i = 0; i < count; i++) {
                        // Create a new element from the inner HTML of the template
                        const shimmerDiv = document.createElement('div');
                        shimmerDiv.innerHTML = shimmerTemplate.innerHTML;
                        shimmerDiv.className = shimmerTemplate.className.replace('hidden', ''); // Add back the base classes
                        notesList.appendChild(shimmerDiv);
                        shimmerCount++;
                    }
                }
            } else {
                notesList.innerHTML = ''; // Clear shimmers
                shimmerCount = 0;
            }
        }

        /**
         * Displays shimmer loading effects for the single note viewer.
         * @param {boolean} show - True to show, false to hide.
         */
        function toggleSingleNoteShimmer(show) {
            if (show) {
                // Clear existing content and show shimmer
                viewerNoteTitle.innerHTML = '<div class="shimmer-text-block shimmer-text-block-lg animate-pulse"></div>';
                viewerNoteContent.innerHTML = `
                    <div class="shimmer-text-block shimmer-text-block-md animate-pulse"></div>
                    <div class="shimmer-text-block shimmer-text-block-md w-11/12 animate-pulse"></div>
                    <div class="shimmer-text-block shimmer-text-block-md w-10/12 animate-pulse"></div>
                `;
                viewerNoteTimestamp.innerHTML = '<div class="shimmer-text-block shimmer-text-block-sm animate-pulse"></div>';

                // Apply shimmer directly to input fields when in editor mode
                editNoteTitleViewer.classList.add('shimmer-bg', 'animate-pulse');
                editNoteContentViewer.classList.add('shimmer-bg', 'animate-pulse');

                // Ensure the containers themselves are visible
                viewerNoteTitle.classList.remove('hidden');
                viewerNoteContent.classList.remove('hidden');
                viewerNoteTimestamp.classList.remove('hidden');

            } else {
                // Clear shimmer from viewer and editor fields
                viewerNoteTitle.innerHTML = '';
                viewerNoteContent.innerHTML = '';
                viewerNoteTimestamp.innerHTML = '';

                editNoteTitleViewer.classList.remove('shimmer-bg', 'animate-pulse');
                editNoteContentViewer.classList.remove('shimmer-bg', 'animate-pulse');
            }
        }


        /**
         * Sets the loading state for a button.
         * @param {HTMLButtonElement} button - The button element.
         * @param {boolean} isLoading - True to set loading state, false to reset.
         * @param {string} originalText - The original text of the button.
         */
        function setButtonLoading(button, isLoading, originalText) {
            if (isLoading) {
                button.dataset.originalText = originalText; // Store original text
                button.disabled = true;
                button.textContent = 'Loading...';
                button.classList.add('opacity-75', 'cursor-not-allowed');
            } else {
                button.disabled = false;
                button.textContent = button.dataset.originalText || originalText; // Restore original text
                button.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }

        /**
         * Applies exponential backoff for retrying API calls.
         * @param {Function} apiCall - The API function to call.
         * @param {Array} args - Arguments to pass to the API function.
         * @param {number} retries - Number of retries.
         * @param {number} delay - Initial delay in ms.
         * @returns {Promise<any>} The result of the API call.
         */
        async function withExponentialBackoff(apiCall, args = [], retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    return await apiCall(...args);
                } catch (error) {
                    if (i < retries - 1) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Exponential increase
                    } else {
                        throw error; // Re-throw if all retries fail
                    }
                }
            }
        }

        // --- Routing Logic ---

        /**
         * Renders the appropriate section based on the URL.
         */
        async function renderPage() {
            const params = new URLSearchParams(window.location.search);
            const noteId = params.get('noteid');

            // Hide all main sections first
            authSection.classList.add('hidden');
            notesSection.classList.add('hidden');
            singleNoteViewerSection.classList.add('hidden');

            if (!currentUserId) {
                // Not authenticated, show auth section
                authSection.classList.remove('hidden');
                // Ensure note list listener is unsubscribed when logged out
                if (unsubscribeNotes) {
                    unsubscribeNotes();
                    unsubscribeNotes = null;
                }
                return;
            }

            // Authenticated
            if (noteId) {
                // Show single note viewer
                singleNoteViewerSection.classList.remove('hidden');
                await loadSingleNote(noteId);
            } else {
                // Show main notes list
                notesSection.classList.remove('hidden');
                loadNotesList();
            }
        }

        // Listen for browser history changes (back/forward buttons)
        window.addEventListener('popstate', renderPage);

        /**
         * Navigates to a new URL without a full page reload.
         * @param {string} path - The path to navigate to (e.g., '/', '?noteid=abc').
         */
        function navigate(path) {
            const params = new URLSearchParams(window.location.search);
            const currentNoteId = params.get('noteid');
            const currentPath = window.location.pathname;

            let targetUrl = currentPath;

            if (path === '/') {
                // Navigating home, clear the query string
                targetUrl = currentPath;
                if (!targetUrl.endsWith('/')) {
                    targetUrl += '/';
                }
                if (currentNoteId) {
                    targetUrl = targetUrl.replace(new RegExp(`\\?noteid=${currentNoteId}`), '');
                }
            } else if (path.startsWith('?')) {
                // Navigating to a note
                targetUrl = `${currentPath}${path}`;
            }

            // Use replaceState instead of pushState to prevent extra history entries
            window.history.pushState({}, '', targetUrl);
            renderPage();
        }

        // --- Auth Event Listeners ---
        toggleAuthMode.addEventListener('click', () => {
            isSignInMode = !isSignInMode;
            if (isSignInMode) {
                authHeading.textContent = 'Sign In';
                signInForm.classList.remove('hidden');
                signUpForm.classList.add('hidden');
                toggleAuthMode.textContent = "Don't have an account? Sign Up";
            } else {
                authHeading.textContent = 'Sign Up';
                signInForm.classList.add('hidden');
                signUpForm.classList.remove('hidden');
                toggleAuthMode.textContent = "Already have an account? Sign In";
            }
        });

        signInForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setButtonLoading(signInBtn, true, 'Sign In');
            const email = e.target.signInEmail.value;
            const password = e.target.signInPassword.value;
            try {
                await withExponentialBackoff(signInWithEmailAndPassword, [auth, email, password]);
            } catch (error) {
                showMessageModal('Sign In Failed', error.message);
            } finally {
                setButtonLoading(signInBtn, false, 'Sign In');
            }
        });

        signUpForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setButtonLoading(signUpBtn, true, 'Sign Up');
            const email = e.target.signUpEmail.value;
            const password = e.target.signUpPassword.value;
            try {
                await withExponentialBackoff(createUserWithEmailAndPassword, [auth, email, password]);
            } catch (error) {
                showMessageModal('Sign Up Failed', error.message);
            } finally {
                setButtonLoading(signUpBtn, false, 'Sign Up');
            }
        });

        googleSignInBtn.addEventListener('click', async () => {
            setButtonLoading(googleSignInBtn, true, 'Sign in with Google');
            const provider = new GoogleAuthProvider();
            try {
                await withExponentialBackoff(signInWithPopup, [auth, provider]);
            } catch (error) {
                if (error.code !== 'auth/popup-closed-by-user') {
                    showMessageModal('Google Sign In Failed', error.message);
                }
            } finally {
                setButtonLoading(googleSignInBtn, false, 'Sign in with Google');
            }
        });

        signOutBtn.addEventListener('click', async () => {
            const confirmed = await showMessageModal('Confirm Sign Out', 'Are you sure you want to sign out?', true);
            if (confirmed) {
                try {
                    await withExponentialBackoff(signOut, [auth]);
                } catch (error) {
                    showMessageModal('Sign Out Failed', error.message);
                }
            }
        });

        signOutBtnViewer.addEventListener('click', async () => {
            const confirmed = await showMessageModal('Confirm Sign Out', 'Are you sure you want to sign out?', true);
            if (confirmed) {
                try {
                    await withExponentialBackoff(signOut, [auth]);
                } catch (error) {
                    showMessageModal('Sign Out Failed', error.message);
                }
            }
        });
        
        // Added Forgot Password button listener
        forgotPasswordBtn.addEventListener('click', async () => {
            const email = document.getElementById('signInEmail').value;
            if (!email) {
                showMessageModal('Error', 'Please enter your email address to reset your password.');
                return;
            }
            try {
                await withExponentialBackoff(sendPasswordResetEmail, [auth, email]);
                showMessageModal('Success', 'Password reset email sent. Please check your inbox.');
            } catch (error) {
                showMessageModal('Error', 'Failed to send password reset email: ' + error.message);
            }
        });

        // --- Note Management Functions (Main List) ---

        /**
         * Renders a single note card for the main list.
         * @param {Object} note - The note object from Firestore.
         * @returns {HTMLElement} The created note card element.
         */
        function createNoteCard(note) {
            const noteCard = document.createElement('div');
            noteCard.id = `note-${note.id}`;
            noteCard.className = 'bg-white p-6 rounded-xl shadow-md border border-gray-200 flex flex-col justify-between transform transition-all duration-300 hover:scale-102 hover:shadow-lg cursor-pointer'; // Added cursor-pointer
            noteCard.innerHTML = `
                <div>
                    <h4 class="text-xl font-semibold mb-2 text-gray-900">${note.title}</h4>
                    <p class="text-gray-700 text-sm mb-4">${note.content.substring(0, 100)}${note.content.length > 100 ? '...' : ''}</p>
                    <p class="text-gray-500 text-xs mt-2">Created: ${note.createdAt?.toDate ? new Date(note.createdAt.toDate()).toLocaleString() : 'N/A'}</p>
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button data-id="${note.id}"
                            class="edit-note-btn px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition font-medium text-sm" onclick="event.stopPropagation()">Edit</button>
                    <button data-id="${note.id}"
                            class="delete-note-btn px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-medium text-sm" onclick="event.stopPropagation()">Delete</button>
                </div>
            `;

            // Click listener for the card to navigate to the viewer
            noteCard.addEventListener('click', () => {
                navigate(`?noteid=${note.id}`);
            });

            // Edit button handler (stops propagation to prevent card click)
            noteCard.querySelector('.edit-note-btn').addEventListener('click', (e) => {
                navigate(`?noteid=${e.target.dataset.id}`);
                setTimeout(() => {
                    // Check if the viewer section is actually visible before trying to switch mode
                    if (!singleNoteViewerSection.classList.contains('hidden')) {
                        setViewerMode(false); // Switch to editor mode
                    }
                }, 100); // Small delay to ensure note is loaded before switching mode
            });

            // Delete button handler (stops propagation to prevent card click)
            noteCard.querySelector('.delete-note-btn').addEventListener('click', async (e) => {
                const id = e.target.dataset.id;
                const confirmed = await showMessageModal('Confirm Delete', 'Are you sure you want to delete this note?', true);
                if (confirmed) {
                    try {
                        const noteDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/notes`, id);
                        await withExponentialBackoff(deleteDoc, [noteDocRef]);
                        showMessageModal('Success', 'Note deleted successfully!');
                    } catch (error) {
                        showMessageModal('Error', 'Failed to delete note: ' + error.message);
                    }
                }
            });

            return noteCard;
        }

        // --- Note Form Event Listeners (Main List) ---
        addNoteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setButtonLoading(addNoteBtn, true, 'Add Note');
            const title = noteTitleInput.value.trim();
            const content = noteContentInput.value.trim();

            if (!title) {
                showMessageModal('Input Error', 'Note title cannot be empty.');
                setButtonLoading(addNoteBtn, false, 'Add Note');
                return;
            }

            try {
                const notesCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/notes`);
                await withExponentialBackoff(addDoc, [notesCollectionRef, {
                    title,
                    content,
                    createdAt: serverTimestamp()
                }]);
                noteTitleInput.value = '';
                noteContentInput.value = '';
                showMessageModal('Success', 'Note added successfully!');
            } catch (error) {
                showMessageModal('Error', 'Failed to add note: ' + error.message);
            } finally {
                setButtonLoading(addNoteBtn, false, 'Add Note');
            }
        });

        // --- Search Functionality ---
        function searchNotes(query) {
            notesList.innerHTML = '';
            const normalizedQuery = query.toLowerCase().trim();

            if (normalizedQuery === '') {
                // If query is empty, show all notes
                renderNotes(allNotes);
                return;
            }

            const filteredNotes = allNotes.filter(note =>
                note.title.toLowerCase().includes(normalizedQuery) ||
                note.content.toLowerCase().includes(normalizedQuery)
            );

            renderNotes(filteredNotes);
        }

        function renderNotes(notesToRender) {
            notesList.innerHTML = '';
            if (notesToRender.length === 0) {
                notesList.innerHTML = '<p class="col-span-full text-center text-gray-500 text-lg py-10">No notes found matching your search.</p>';
            } else {
                notesToRender.forEach(note => {
                    notesList.appendChild(createNoteCard(note));
                });
            }
        }

        // Add event listeners for the search input
        searchInput.addEventListener('input', (e) => {
            searchNotes(e.target.value);
        });

        // --- Single Note Viewer Functions ---

        /**
         * Loads and displays a single note in the viewer section.
         * @param {string} noteId - The ID of the note to load.
         */
        async function loadSingleNote(noteId) {
            // Unsubscribe from main notes list if currently active
            if (unsubscribeNotes) {
                unsubscribeNotes();
                unsubscribeNotes = null;
            }

            if (!noteId || !currentUserId) {
                showMessageModal('Error', 'Invalid note ID or user not authenticated.');
                navigate('/'); // Go back to home
                return;
            }

            setViewerMode(true); // Default to viewer mode
            toggleSingleNoteShimmer(true); // Show shimmer for single note content

            try {
                const noteDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/notes`, noteId);
                const noteSnap = await withExponentialBackoff(getDoc, [noteDocRef]);

                toggleSingleNoteShimmer(false); // Hide shimmer once data is fetched

                if (noteSnap.exists()) {
                    const noteData = noteSnap.data();
                    viewerNoteTitle.textContent = noteData.title;
                    viewerNoteContent.textContent = noteData.content;
                    viewerNoteTimestamp.textContent = `Created: ${noteData.createdAt?.toDate ? new Date(noteData.createdAt.toDate()).toLocaleString() : 'N/A'}`;

                    // Populate editor fields
                    editNoteIdViewer.value = noteId;
                    editNoteTitleViewer.value = noteData.title;
                    editNoteContentViewer.value = noteData.content;

                } else {
                    showMessageModal('Error', 'Note not found.');
                    navigate('/'); // Go back to home if note doesn't exist
                }
            } catch (error) {
                toggleSingleNoteShimmer(false); // Hide shimmer on error
                showMessageModal('Error', 'Failed to load note: ' + error.message);
                navigate('/'); // Go back to home on error
            }
        }

        /**
         * Toggles between viewer and editor mode for a single note.
         * @param {boolean} isView - True for viewer mode, false for editor mode.
         */
        function setViewerMode(isView) {
            isViewerMode = isView;
            if (isViewerMode) {
                viewerMode.classList.remove('hidden');
                editorMode.classList.add('hidden');
                toggleViewEditModeBtn.textContent = 'Show in Editor Mode';
            } else {
                viewerMode.classList.add('hidden');
                editorMode.classList.remove('hidden');
                toggleViewEditModeBtn.textContent = 'Show in Viewer Mode';
            }
        }

        // --- Single Note Viewer Event Listeners ---
        goHomeBtn.addEventListener('click', () => {
            navigate('/');
        });

        toggleViewEditModeBtn.addEventListener('click', () => {
            setViewerMode(!isViewerMode);
        });
        
        // New: Add a click event listener for the "Copy Text" button
        copyTextBtn.addEventListener('click', async () => {
            const textToCopy = viewerNoteContent.textContent;
            try {
                await navigator.clipboard.writeText(textToCopy);
                showMessageModal('Success', 'Note content copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showMessageModal('Error', 'Failed to copy text. Please try again or copy manually.');
            }
        });


        editNoteFormViewer.addEventListener('submit', async (e) => {
            e.preventDefault();
            setButtonLoading(saveChangesBtn, true, 'Save Changes');
            const id = editNoteIdViewer.value;
            const title = editNoteTitleViewer.value.trim();
            const content = editNoteContentViewer.value.trim();

            if (!title) {
                showMessageModal('Input Error', 'Note title cannot be empty.');
                setButtonLoading(saveChangesBtn, false, 'Save Changes');
                return;
            }

            try {
                const noteDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/notes`, id);
                await withExponentialBackoff(updateDoc, [noteDocRef, {
                    title,
                    content
                }]);
                showMessageModal('Success', 'Note updated successfully!');
                setViewerMode(true); // Switch back to viewer mode after saving
                await loadSingleNote(id); // Reload the note to reflect changes
            } catch (error) {
                showMessageModal('Error', 'Failed to update note: ' + error.message);
            } finally {
                setButtonLoading(saveChangesBtn, false, 'Save Changes');
            }
        });


        // --- Authentication State Observer ---
        onAuthStateChanged(auth, async (user) => {
            currentUserId = user ? user.uid : null;

            if (user) {
                userIdDisplay.textContent = `User ID: ${user.uid}`;
                renderPage(); // Render appropriate page after auth state is known
            } else {
                // User logged out
                currentUserId = null;
                if (unsubscribeNotes) {
                    unsubscribeNotes(); // Unsubscribe from notes listener
                    unsubscribeNotes = null;
                }
                navigate('/'); // Go to home (which will show auth section)
                renderPage(); // Render auth section
            }
        });

        /**
         * Sets up the real-time listener for the main notes list.
         */
        function loadNotesList() {
            if (!currentUserId || !db) {
                console.error("Cannot load notes list: User not authenticated or Firestore not initialized.");
                return;
            }

            toggleNotesListShimmer(true); // Show shimmer while loading notes

            // If there's an existing listener, unsubscribe it first
            if (unsubscribeNotes) {
                unsubscribeNotes();
            }

            const notesCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/notes`);
            const q = query(notesCollectionRef); // orderBy commented out to avoid index issues

            unsubscribeNotes = onSnapshot(q, (snapshot) => {
                toggleNotesListShimmer(false); // Hide shimmer once data is received
                allNotes = []; // Clear and rebuild the notes array
                snapshot.forEach(doc => {
                    allNotes.push({ id: doc.id, ...doc.data() });
                });
                // Sort notes in memory by createdAt descending
                allNotes.sort((a, b) => {
                    const timeA = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
                    const timeB = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
                    return timeB - timeA;
                });
                renderNotes(allNotes);
            }, (error) => {
                console.error("Error fetching notes: ", error);
                showMessageModal('Error', 'Failed to load notes: ' + error.message);
                toggleNotesListShimmer(false); // Hide shimmer on error
            });
        }


        // Initial page render on window load
        window.onload = () => {
            // Hide the template and remove it from the DOM after initial load
            shimmerTemplate.classList.add('hidden');
            shimmerTemplate.remove();
            // onAuthStateChanged will trigger renderPage after auth state is determined
        };

    </script>
</body>
</html>
